---
harness('inviqa/viper'):
  description: A docker based development environment for viper.
  require:
    services:
      - proxy
    confd:
      - harness:/
---
command('gateway rebuild'):
  env:
    COMPOSE_PROJECT_NAME: = @('namespace')
  exec: |
    #!bash(workspace:/)
    passthru ws exec app build:gateway
    run ws gateway restart
command('gateway <action>'):
  env:
    COMPOSE_PROJECT_NAME: = @('namespace')
    ACTION: = input.argument('action')
  exec: |
    #!bash(workspace:/)
    passthru docker-compose exec node supervisorctl "${ACTION}" "gateway"
command('client <action>'):
  env:
    COMPOSE_PROJECT_NAME: = @('namespace')
    ACTION: = input.argument('action')
  exec: |
    #!bash(workspace:/)
    passthru docker-compose exec node supervisorctl "${ACTION}" "client"
---
attributes:
  app:
    image: node:14-slim
    build:
      steps:
      - run yarn install
      - run yarn generate:types
      - run yarn build:core
      - run yarn build:deps
    environment:
      HOST_OS_FAMILY: = @('host.os')
    environment_secrets: {}
    gateway:
      port: 4000
      resources:
        memory: 512MiB
      build:
        steps:
        - run yarn build:app:gateway
      environment:
        GATEWAY_HOST: = 'gateway-' ~ @('hostname')
        DRUPAL_TOKEN_SECRET: 1234
    client:
      port: 3000
      resources:
          memory: 512MiB
      build:
        steps:
        - run yarn build:app:client
      environment:
        CLIENT_HOST: = @('hostname')
---
import:
  - harness/config/*.yml
  - harness/attributes/*.yml
  - harness/attributes/environment/={env('MY127WS_ENV','local')}.yml
